<html>
<head>
    <script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="node_modules/jquery-csv/src/jquery.csv.min.js"></script>
</head>
<body>
    <div id="graph" style="width:100%;height:80%;"></div>
    <div id="options_form"></div>
    <p>
    Data source: <a href="https://github.com/CSSEGISandData/COVID-19">COVID-19 Cases by Johns Hopkins University</a>.<br>
    </p>
    <script>
	var data = {};

	function parseData(csv_data) {
            const province_state = 0;
            const country_region = 1;
            const lat = 2;
            const lng = 3;
            const first_date = 4;

            header = csv_data[0]
            data['dates'] = header.slice(first_date, header.length);

            var sequence = {};
            for (var i = 1; i < csv_data.length; i++) {
                row = csv_data[i]
                name = row[country_region]
                for (var j = first_date; j < row.length; j++) {
                    row[j] = parseInt(row[j])
                }
                if (name in sequence) {
                    for (var j = first_date; j < row.length; j++) {
                        sequence[name][j - first_date] += row[j];
                    }
                } else {
                    sequence[name] = row.slice(first_date, row.length)
                }
            }
	    data['sequence'] = sequence
	}

        const continent_table = {
            "Mainland China": "asia",
            "Indonesia": "asia",
            "Thailand": "asia",
            "Japan": "asia",
            "South Korea": "asia",
            "Macau": "asia",
            "Hong Kong": "asia",
            "Morocco": "africa",
            "Egypt": "africa",
            "Portugal": "europe",
            "Greece": "europe",
            "Switzerland": "europe",
            "Sweden": "europe",
            "Spain": "europe",
            "Belgium": "europe",
            "Austria": "europe",
            "Liechtenstein": "europe",
            "Andorra": "europe",
            "Ireland": "europe",
            "Luxembourg": "europe",
            "Monaco": "europe",
            "Norway": "europe",
            "Denmark": "europe",
            "Netherlands": "europe",
            "Iceland": "europe",
            "New Zealand": "oceania",
            "Australia": "oceania",
            "Mexico": "north_america",
            "US": "north_america",
            "Canada": "north_america",
            "Argentina": "south_america",
            "Brazil": "south_america",
        };
        function get_continent(country) {
            if (country in continent_table) {
                return continent_table[country];
            }
            console.log("WARNING: Don't know continent for", country)
            return "unknown";
        }

	function updateForm() {
	    var div = document.getElementById("options_form");
	    var form = document.createElement("form");
	    for (name of Object.keys(data['sequence']).sort()) {
		var input = document.createElement('input');
		input.setAttribute("type", "checkbox");
		input.setAttribute("id", name);
		if (name == "US") {
		    input.setAttribute("checked", true);
		}
		input.setAttribute("onClick", "updateGraph()")
		form.appendChild(input)

		var label = document.createElement('label');
		label.setAttribute('for', name)
		label.innerHTML = name
		form.appendChild(label)
	    }
	    div.appendChild(form);
	}

        function updateGraph() {
            var traces = [];
            for (var name in data['sequence']) {
		checkbox = document.getElementById(name)
		if (!(checkbox.checked)) {
		    continue
		}
                var trace = {
                    x: data['dates'],
                    y: data['sequence'][name],
                    name: name
                };
                traces.push(trace)
            }

            graph = document.getElementById('graph');
            Plotly.newPlot(graph, traces, { margin: { t: 0 } } );
        }

	$.ajax({
	  type: "GET",  
	  url: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv",
	  dataType: "text",       
	  success: function(response)  
	  {
	      parseData($.csv.toArrays(response));
	      updateForm()
	      updateGraph();
	  }   
	});
    </script>
</body>
</html>
