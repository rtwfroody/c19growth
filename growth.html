<html>
<head>
    <link rel="stylesheet" href="growth.css">
    <title>COVID-19 Cases Over Time</title>
    <script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="node_modules/jquery-csv/src/jquery.csv.min.js"></script>
</head>
<body>
    <div id="graph" style="width:100%;height:80%;"></div>
    <div id="error"></div>
    <div id="options_form"></div>
    <p>
    Data source: <a href="https://github.com/CSSEGISandData/COVID-19">COVID-19
        Cases by Johns Hopkins University</a>.<br>
    Send feedback to tim@casualhacker.net.<br>
    </p>
    <h2>More Data</h2>
    <ul>
        <li><a
                href="https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">Coronavirus
                COVID-19 Global Cases by Johns Hopkins CSSE</a>
        <li><a href="https://infection2020.com/">United States Coronavirus
        (COVID-19) Tracker</a></li>
    </ul>
    <script>
	var data = {};

	function buildData(covid_csv, population_csv) {
            population_map = {}
            // Translate from world bank name to Johns Hopkins name
            translate_population_country = {
                "United States": "US",
                "China": "Mainland China",
                "Korea, Rep.": "South Korea",
                "Macao SAR, China": "Macau",
                "Hong Kong SAR, China": "Hong Kong",
                "United Kingdom": "UK",
                "Russian Federation": "Russia",
                "Egypt, Arab Rep.": "Egypt",
                "Iran, Islamic Rep.": "Iran",
                "Slovak Republic": "Slovakia",
                "St. Martin (French part)": "Martinique",
            }
            console.log(translate_population_country)
            for (row of population_csv) {
                name = row[0]
                if (name in translate_population_country) {
                    name = translate_population_country[name]
                    console.log(row[0], name)
                }
                population_map[name] = row[1]
            }

            const province_state = 0;
            const country_region = 1;
            const lat = 2;
            const lng = 3;
            const first_date = 4;

            header = covid_csv[0]
            data['dates'] = header.slice(first_date, header.length);

            var sequence_map = {};
            for (var i = 1; i < covid_csv.length; i++) {
                row = covid_csv[i]
                var ids = [["Country", row[country_region]]]
                if (row[country_region] == "US") {
                    ids.push(["US State", row[province_state].replace(/.*, */, "")])
                }
                for (id of ids) {
                    for (var j = first_date; j < row.length; j++) {
                        row[j] = parseInt(row[j])
                    }
                    if (id in sequence_map) {
                        for (var j = first_date; j < row.length; j++) {
                            sequence_map[id].data[j - first_date] += row[j];
                        }
                    } else {
                        sequence_map[id] = {}
                        sequence_map[id].id = id
                        sequence_map[id].data = row.slice(first_date, row.length)
                        sequence_map[id].group = id[0]
                        sequence_map[id].name = id[1]

                        sequence_map[id].population = population_map[sequence_map[id].name]
                        if (!sequence_map[id].population) {
                            console.log("WARNING: Don't know population of",
                                sequence_map[id].group,
                                sequence_map[id].name)
                        }
                    }
                }
            }
            data['sequences'] = Object.values(sequence_map).sort(
                function order(a, b) { return a.id[1].localeCompare(b.id[1]) })
	}

        const continent_table = {
            "Mainland China": "asia",
            "Indonesia": "asia",
            "Thailand": "asia",
            "Japan": "asia",
            "South Korea": "asia",
            "Macau": "asia",
            "Hong Kong": "asia",
            "Morocco": "africa",
            "Egypt": "africa",
            "Portugal": "europe",
            "Greece": "europe",
            "Switzerland": "europe",
            "Sweden": "europe",
            "Spain": "europe",
            "Belgium": "europe",
            "Austria": "europe",
            "Liechtenstein": "europe",
            "Andorra": "europe",
            "Ireland": "europe",
            "Luxembourg": "europe",
            "Monaco": "europe",
            "Norway": "europe",
            "Denmark": "europe",
            "Netherlands": "europe",
            "Iceland": "europe",
            "New Zealand": "oceania",
            "Australia": "oceania",
            "Mexico": "north_america",
            "US": "north_america",
            "Canada": "north_america",
            "Argentina": "south_america",
            "Brazil": "south_america",
        };
        function get_continent(country) {
            if (country in continent_table) {
                return continent_table[country];
            }
            console.log("WARNING: Don't know continent for", country)
            return "unknown";
        }

        function add_label(element, id, label) {
            var l = document.createElement('label');
            l.setAttribute('for', id)
            l.innerHTML = label
            element.appendChild(l)
        }

        function add_radio(element, id, name, checked, text) {
            var input = document.createElement('input');
            input.setAttribute("type", "radio");
            input.setAttribute("name", name);
            input.setAttribute("id", id);
            if (checked) {
                input.setAttribute("checked", true);
            }
            input.setAttribute("onClick", "updateGraph()")
            element.appendChild(input)
            add_label(element, id, text)
        }

	function updateForm() {
	    var div = document.getElementById("options_form");
	    var form = document.createElement("form");
            var grouped = {}

	    for (sequence of data['sequences']) {
                if (sequence.group in grouped) {
                    grouped[sequence.group].push(sequence)
                } else {
                    grouped[sequence.group] = [sequence]
                }
            }

            table = document.createElement("table")
            tr = document.createElement("tr")
            for (group of Object.keys(grouped).sort()) {
                td = document.createElement("td")
                for (sequence of grouped[group]) {
                    name = sequence.name
                    var input = document.createElement('input');
                    input.setAttribute("type", "checkbox");
                    input.setAttribute("id", sequence.id);
                    if (name == "US") {
                        input.setAttribute("checked", true);
                    }
                    input.setAttribute("onClick", "updateGraph()")
                    td.appendChild(input)

                    add_label(td, name, name)
                }
                tr.appendChild(td)
            }
            table.appendChild(tr)
            form.appendChild(table)

            table = document.createElement("table")
            tr = document.createElement("tr")
            th = document.createElement("th")
            th.setAttribute("align", "left")
            th.innerHTML = "Options"
            tr.appendChild(th)
            table.appendChild(tr)

            tr = document.createElement("tr")

            td = document.createElement("td")
            add_radio(td, "linear_scale", "scale", true, "Linear Scale")
            add_radio(td, "log_scale", "scale", false, "Log Scale")
            tr.appendChild(td)

            td = document.createElement("td")
            add_radio(td, "absolute_cases", "cases", true, "Absolute Number of Cases")
            add_radio(td, "relative_cases", "cases", false, "Relative Number of Cases")
            tr.appendChild(td)

            table.appendChild(tr)

            form.appendChild(table)
	    div.appendChild(form);
	}

        function updateGraph() {
            error = document.getElementById('error');
            error.innerHTML = ""

            var traces = [];
            relative_cases = document.getElementById("relative_cases").checked
            for (sequence of data['sequences']) {
		checkbox = document.getElementById(sequence.id)
		if (!(checkbox.checked)) {
		    continue
		}

                var trace = {
                    x: data['dates'],
                    name: sequence.name
                };
                if (relative_cases) {
                    if (!sequence.population) {
                        error.innerHTML += "ERROR: Don't know population for " +
                            sequence.group + " " + sequence.name + ".<br/>"
                        continue
                    }
                    trace.y = sequence.data.map(x => 100000.0 * x / sequence.population)
                } else {
                    trace.y = sequence.data
                }
                traces.push(trace)
            }

            layout = {
                    margin: { t: 0 },
                    yaxis: {},
                }
            log_scale = document.getElementById('log_scale')
            if (log_scale.checked) {
                layout.yaxis.type = 'log'
            }
            if (relative_cases) {
                layout.yaxis.title = 'Confirmed cases (per 100,000)'
            } else {
                layout.yaxis.title = 'Confirmed cases (number)'
            }

            graph = document.getElementById('graph');
            Plotly.newPlot(graph, traces, layout);
        }

        $.when(
            $.get("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"),
            $.get("population.csv"),
        ).then(function(covid_response, population_response) {
            buildData($.csv.toArrays(covid_response[0]),
                $.csv.toArrays(population_response[0]))
            updateForm()
            updateGraph();
	});
    </script>
</body>
</html>
