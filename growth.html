<html>
<head>
    <script src="https://cdn.plot.ly/plotly-1.2.0.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="node_modules/jquery-csv/src/jquery.csv.min.js"></script>
</head>
<body>
    <div id="graph" style="width:100%;height:80%;"></div>
    <div id="options_form"></div>
    <p>
    Data source: <a href="https://github.com/CSSEGISandData/COVID-19">COVID-19
        Cases by Johns Hopkins University</a>.<br>
    Send feedback to tim@casualhacker.net.<br>
    </p>
    <script>
	var data = {};

	function parseData(csv_data) {
            const province_state = 0;
            const country_region = 1;
            const lat = 2;
            const lng = 3;
            const first_date = 4;

            header = csv_data[0]
            data['dates'] = header.slice(first_date, header.length);

            var sequence_map = {};
            for (var i = 1; i < csv_data.length; i++) {
                row = csv_data[i]
                var ids = [["Country", row[country_region]]]
                if (row[country_region] == "US") {
                    ids.push(["US State", row[province_state].replace(/.*, */, "")])
                }
                for (id of ids) {
                    for (var j = first_date; j < row.length; j++) {
                        row[j] = parseInt(row[j])
                    }
                    if (id in sequence_map) {
                        for (var j = first_date; j < row.length; j++) {
                            sequence_map[id].data[j - first_date] += row[j];
                        }
                    } else {
                        sequence_map[id] = {}
                        sequence_map[id].id = id
                        sequence_map[id].data = row.slice(first_date, row.length)
                        sequence_map[id].group = id[0]
                        sequence_map[id].name = id[1]
                    }
                }
            }
            data['sequences'] = Object.values(sequence_map).sort(
                function order(a, b) { return a.id[1].localeCompare(b.id[1]) })
	}

        const continent_table = {
            "Mainland China": "asia",
            "Indonesia": "asia",
            "Thailand": "asia",
            "Japan": "asia",
            "South Korea": "asia",
            "Macau": "asia",
            "Hong Kong": "asia",
            "Morocco": "africa",
            "Egypt": "africa",
            "Portugal": "europe",
            "Greece": "europe",
            "Switzerland": "europe",
            "Sweden": "europe",
            "Spain": "europe",
            "Belgium": "europe",
            "Austria": "europe",
            "Liechtenstein": "europe",
            "Andorra": "europe",
            "Ireland": "europe",
            "Luxembourg": "europe",
            "Monaco": "europe",
            "Norway": "europe",
            "Denmark": "europe",
            "Netherlands": "europe",
            "Iceland": "europe",
            "New Zealand": "oceania",
            "Australia": "oceania",
            "Mexico": "north_america",
            "US": "north_america",
            "Canada": "north_america",
            "Argentina": "south_america",
            "Brazil": "south_america",
        };
        function get_continent(country) {
            if (country in continent_table) {
                return continent_table[country];
            }
            console.log("WARNING: Don't know continent for", country)
            return "unknown";
        }

	function updateForm() {
	    var div = document.getElementById("options_form");
	    var form = document.createElement("form");
            var grouped = {}

	    for (sequence of data['sequences']) {
                if (sequence.group in grouped) {
                    grouped[sequence.group].push(sequence)
                } else {
                    grouped[sequence.group] = [sequence]
                }
            }

            table = document.createElement("table")
            tr = document.createElement("tr")
            for (group of Object.keys(grouped).sort()) {
                td = document.createElement("td")
                for (sequence of grouped[group]) {
                    name = sequence.name
                    var input = document.createElement('input');
                    input.setAttribute("type", "checkbox");
                    input.setAttribute("id", sequence.id);
                    console.log(group, name)
                    if (name == "US") {
                        input.setAttribute("checked", true);
                    }
                    input.setAttribute("onClick", "updateGraph()")
                    td.appendChild(input)

                    var label = document.createElement('label');
                    label.setAttribute('for', name)
                    label.innerHTML = name
                    td.appendChild(label)
                }
                tr.appendChild(td)
            }
            table.appendChild(tr)
            form.appendChild(table)
	    div.appendChild(form);
	}

        function updateGraph() {
            var traces = [];
            for (sequence of data['sequences']) {
		checkbox = document.getElementById(sequence.id)
		if (!(checkbox.checked)) {
		    continue
		}
                var trace = {
                    x: data['dates'],
                    y: sequence.data,
                    name: sequence.name
                };
                traces.push(trace)
            }

            graph = document.getElementById('graph');
            Plotly.newPlot(graph, traces, { margin: { t: 0 } } );
        }

	$.ajax({
	  type: "GET",  
	  url: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv",
	  dataType: "text",       
	  success: function(response)  
	  {
	      parseData($.csv.toArrays(response));
	      updateForm()
	      updateGraph();
	  }   
	});
    </script>
</body>
</html>
